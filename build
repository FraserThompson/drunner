#!/bin/bash

MYDIR=$( dirname "$(readlink -f "$0")" )
PERMISSIONSFILE="${MYDIR}/.permissions"

VERSIONSTR="0.7 r"
VERSIONDATE="2016-07-05"
VSHORT="NOT SET"
VCOMBO="NOT SET"
[ -v VTAG ] || VTAG="Dev"

function showhelp {
cat <<EOF >&2

NAME
   build

SYNOPSIS
   build
      Build drunner using docker container for compilation and linking.

   build clean
      Remove intermediate files then build.

   build install
      Build then install for testing (to ~/test).

DESCRIPTION
   dRunner's test harness. Built from ${IMAGENAME}.

EOF
}

function runbuild {
   if [ ! -f "$PERMISSIONSFILE" ] ; then
      echo "Checking permissions"
      (
      cd ${MYDIR}/source
      mkdir -p objs/plugins objs/tests objs/win output
      find . -type d -exec chmod 0777 {} \;
      find . -type f -exec chmod 0666 {} \;
      chmod 0777 deps/colorgcc/colorgcc.pl
      )
      touch "$PERMISSIONSFILE"
   fi

   SECONDS=$(( $(date +%s) - $(date --date="${VERSIONDATE}" +%s) ))
   DAYS=$(( 1+${SECONDS}/(60*60*24) ))
   DATE=`date`
   VSHORT="${VERSIONSTR}${DAYS}"
   VCOMBO="${VSHORT} - ${DATE} [${VTAG}]"

   echo "Building ${VCOMBO}"
   echo "Mapping ${SRC} to /source"
   docker run --rm \
      -e "VCOMBO=${VCOMBO}" \
      -e "VSHORT=${VSHORT}" \
      -v "${SRC}:/source" drunner/builddrunner

   OUTPUT=source/output/drunner-install

   [ -f ${OUTPUT} ] || { echo "Build Failed." ; exit 1 ; }

   cp ${OUTPUT} ${MYDIR}

}

function main {
   SRC=$(echo "${MYDIR}" | sed -e 's|^/cygdrive/\(.\)/|\1:/|g')
   SRC="${SRC}/source"

   COMMAND="build"
   [ $# -eq 0 ] || COMMAND="$1"

   case "$COMMAND" in
      build)
         runbuild
         ;;

      clean)
         docker run --rm -v ${SRC}:/source drunner/builddrunner make dist-clean
         rm -f "${MYDIR}/drunner-install"
         rm -f "$PERMISSIONSFILE"
         runbuild
         ;;

      install)
         runbuild
         "${MYDIR}/drunner-install" -v ~/temp
         ;;

      *)
         showhelp
         ;;
   esac
}

main "$@"
